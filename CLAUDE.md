# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What This Project Is

An MCP server that enables AI agents to generate complete Figma screens using real, linked component instances from any design system. It bridges AI clients (Claude, Cursor, etc.) to the Figma plugin API via WebSocket, allowing agents to compose screens from actual design system components with proper variant selection, positioning, and prototype interactions.

## Build & Run Commands

```bash
npm run build       # Compile server.ts → dist/server.js
npm run dev         # Run server.ts directly with tsx (development)
npm run start       # Run dist/server.js (production)
```

No automated test suite exists. Testing is manual: start the MCP server, open the Figma Desktop plugin (Plugins → Development → figma-compose-mcp), then invoke tools via an AI client.

## Architecture

```
AI Client (Claude/Cursor) ──MCP stdio──▶ server.ts ──WebSocket──▶ plugin/ui.html ──postMessage──▶ plugin/plugin.js ──▶ Figma Canvas
```

**server.ts** (~480 lines): MCP server exposing 30+ tools. Each tool validates input with Zod, sends a JSON message `{id, action, args}` over WebSocket to the plugin, and awaits a reply (15s timeout). Also exposes `SCREEN-GENERATION.md` and `DESIGN-SYSTEM-EXTRACTION.md` as MCP resources.

**plugin/plugin.js** (~720 lines): Figma plugin with a `handleAction()` dispatcher routing to 60+ handler functions that call the Figma API directly (create frames, place component instances, set fills, manage prototype interactions, extract design tokens). Uses `skipInvisibleInstanceChildren` and `findAllWithCriteria` for fast node traversal.

**plugin/ui.html** (33 lines): Hidden iframe acting as a WebSocket bridge between the plugin sandbox and the MCP server at `ws://127.0.0.1:3055`. Relays messages bidirectionally.

**Design system JSON** (e.g., `M3-DESIGN-SYSTEM.json`): Extracted design system reference containing component IDs, variant axes, color/typography/shape tokens. Generated by the `/extract-design-system` workflow, consumed by agents when composing screens. The filename depends on the source design system.

## Key Technical Details

- **ES Modules**: The project uses `"type": "module"` — use `import`/`export`, not `require`.
- **TypeScript config**: Target ES2022, `strict: false`, output to `dist/`.
- **Tool input validation**: Every MCP tool uses Zod schemas. When adding tools, define the schema inline in the `server.tool()` call.
- **WebSocket protocol**: Messages are JSON with `{id, action, ...args}` from server→plugin and `{replyTo, result?, error?}` from plugin→server. The `id` is a counter-based string.
- **Component references**: Use `componentId` for components in the current file, `componentKey` for published library components (triggers `importComponentByKeyAsync`).
- **Adding a new tool**: Add the Zod schema + handler in `server.ts`, then add the corresponding action handler in `plugin/plugin.js`'s `handleAction()` dispatcher.

## Agent Workflow Skills

Two skills are available as slash commands (defined in `.claude/skills/`):

- `/generate-screen [description]` — Compose a complete UI screen in Figma using design system components. Covers frame creation, component lookup, variant selection, measurement-driven positioning, and instance property customization.
- `/extract-design-system [description]` — Extract colors, typography, shape tokens, and component IDs from any Figma design kit into a structured JSON reference.
